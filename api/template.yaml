AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
  Api:
    Cors:
      AllowMethods: "'*'"
      AllowOrigin: "'*'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
  Function:
    Timeout: 3
    MemorySize: 128
    Runtime: python3.9
    Architectures:
    - x86_64
    Environment:
      Variables:
        TRADIER_PROD_ENDPOINT: 'https://api.tradier.com'
        TRADIER_SANDBOX_ENDPOINT: 'https://sandbox.tradier.com'
        TRADIER_PROD_ACCESS_TOKEN: '{{resolve:secretsmanager:TRADIER:SecretString:TRADIER_PROD_ACCESS_TOKEN}}'
        TRADIER_SANDBOX_ACCOUNT_NO: '{{resolve:secretsmanager:TRADIER:SecretString:TRADIER_SANDBOX_ACCOUNT_NO}}'
        TRADIER_SANDBOX_API_TOKEN: '{{resolve:secretsmanager:TRADIER:SecretString:TRADIER_SANDBOX_API_TOKEN}}'
        SUPABASE_JWT_SECRET: '{{resolve:secretsmanager:SUPABASE:SecretString:SUPABASE_JWT_SECRET}}'

    LoggingConfig:
      LogFormat: JSON



Resources:
  StockAPI:
    Type: AWS::Serverless::Api
    Properties:
      Cors:
        AllowMethods: "'*'"
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
      Name: Stock Trading API
      StageName: Prod
      Auth:
        AddDefaultAuthorizerToCorsPreflight: false
        DefaultAuthorizer: SupabaseAuthorizer
        Authorizers:
          SupabaseAuthorizer:
            FunctionPayloadType: TOKEN
            FunctionArn: !GetAtt SupabaseAuthorizerFunction.Arn
  GetClockFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetClock.get_clock
      Events:
        Api:
          Type: Api
          Properties:
            Auth:
              Authorizer: NONE
            RestApiId: !Ref StockAPI
            Path: /clock
            Method: GET
  GetSymbolsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetSymbols.get_symbols
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /symbol/{security_type}
            Method: GET
  GetOptionSymbolsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetOptionSymbols.get_option_symbols
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /option
            Method: GET
  GetCompaniesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetCompanies.get_companies
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /search
            Method: GET
  GetQuoteFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetQuotes.get_quotes
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /quote
            Method: GET
  GetOptionChainFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetOptionChains.get_option_chains
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /option/chains
            Method: GET
  GetOptionExpirationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetOptionExpirations.get_option_expirations
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /option/expirations
            Method: GET
  GetMarketStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetMarketStream.get_market_stream
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /stream/market
            Method: POST
  GetAccountStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: GetAccountStream.get_account_stream
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /stream/account
            Method: POST
  AddWatchListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: AddWatchList.add_watch_list
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref StockAPI
            Path: /watch/{sub}/{name}
            Method: POST
  SupabaseAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/
      Handler: AuthenticateWithSupabase.authenticate_with_supabase
      Events:
        Api:
          Type: Api
          Properties:
            Path: /auth/supabase
            Method: POST

Outputs:
  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
  # Find out more about other implicit resources you can reference within SAM
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  ApiEndpoint:
    Description: API Gateway endpoint URL for Prod stage for Hello World function
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
#  GetClockFunction:
#    Description: Hello World Lambda Function ARN
#    Value: !GetAtt GetClockFunction.Arn
#  GetClockFunctionIamRole:
#    Description: Implicit IAM Role created for Hello World function
#    Value: !GetAtt GetClockFunctionRole.Arn